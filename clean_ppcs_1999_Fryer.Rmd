---
title: "ppcs_1999_Fryer"
author: "Brenda Fried"
date: "9/3/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-libraries}
library(tidyverse)
library(asciiSetupReader)
library(foreign)
library(dplyr)
library(here)
```

``` {r load-data}
ppcs_1999_F <- read_ascii_setup(here('raw_data','03151-0001-Data.txt'),here('raw_data', '03151-0001-Setup.sas'))
#ppcs_1999_F <- ppcs_1999_F[, !duplicated(colnames(ppcs_1999_F))]

#rename columns so don't have issue with duplicate column names
new_names <- seq(1:311)
ppcs_1999_F <- as_tibble(ppcs_1999_F, .name_repair = ~new_names)
ppcs_1999_F <- data.frame(ppcs_1999_F)

df <- data.frame(colnames(ppcs_1999_F), colnames(ppcs_1999))
view(df)
```

```{r}
#had contact
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(had_contact = case_when(
    (X10 == 'Yes' & X11 == 'Yes') ~ 1,
    (X10 == 'No' | (X10 == 'Yes' & X11 == 'No')) ~ 0,
    (X10 == 'Out of Universe/Missing') ~ NA_real_
  ))
```

```{r}
# document difference on how white includes ppl who dont know if they are of hispanic origin.
# civilian race
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_race = case_when(
    (X6 == "White" & X7 != "Yes") ~ "white",
    (X6 == "Black" ) ~ "black",
    (X7 == "Yes" & X6 != "Black") ~ "hispanic",
    (X6 == "Other" &  X7 != "Yes") ~ "other"
  ))
```

```{r}
#Civilian Age
ppcs_1999_F <- ppcs_1999_F %>% 
  mutate(civilian_age = X5)
```

```{r}
#Civilian Gender
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_gender = case_when(
    (X4 == "Male") ~ 1,
    (X4 == "Female") ~ 0
  ))
```

```{r}
#Civilian Employed

ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_employed = case_when(
    (X265 == 'Yes') ~1,
    (X265 == 'No') ~ 0
     ))
```

```{r}
#civilian income

# They did not factor
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_income = case_when(
    (X264 == 'Less than $20,000 or NA')~1,
    (X264 == '$20,000-49,999')~2,
    (X264 == '$50,000 or more')~3
  ))
```

```{r}
#Population-size
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(population_size = case_when(
    (X267 == 'Under 100,000/not a place') ~ 1,
    (X267 == '100,000-499,999') ~ 2,
    (X267 == '500,000-999,999') ~ 3,
    (X267 == '1 million or more')~4,
    TRUE ~ NA_real_
  ))
```

```{r}
# type of incident
#everything was cleaned twice once for traffic stops and once for other stops

ppcs_1999_F <- ppcs_1999_F %>%
  mutate(type_of_incident = case_when(
    (X12 == 'Once' | X12 == 'More than once') ~ "traffic",
    (X152 != 'Out of Universe/Missing' ) ~ "other",
    (X152 == 'Out of Universe/Missing' & had_contact == 1  & X176 == "No") ~ "other"
  ))
```

```{r}
# had contct for incident types
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(had_contact_traffic = ifelse((type_of_incident == 'traffic' & had_contact == 1), 1, 0)) %>%
  mutate(had_contact_other = ifelse((type_of_incident == 'other' & had_contact == 1), 1, 0))
  
```

## Traffic Stops
```{r}
# number of officers - traffic stop
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(num_officers_t = ifelse(X34 == "Out of Universe/Missing", NA_real_, X34)) %>%
  mutate(num_officers_t = ifelse(num_officers_t == "One", 1, X34)) %>%
  mutate(num_officers_t = as.numeric(num_officers_t))
```

```{r}
# Officer Race - traffic stop
w <- c("All white", "Mostly white")
b <- c("All black", "Mostly black")
o <- c("All of another race", "Mostly another race")
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(off_race_t = case_when(
    (( num_officers_t == 1 & X36 == 'White' ) | (num_officers_t %in% seq(2, 30) & X35 %in% w)) ~ "white" ,
    (( num_officers_t == 1 & X36 == 'Black' ) | (num_officers_t %in% seq(2, 30) & X35 %in% b)) ~ "black",
    (( num_officers_t == 1 & X36 == 'Some other race' ) | (num_officers_t %in% seq(2, 30) & X35 %in% o)) ~ "other",
    (num_officers_t %in% seq(2, 30) & X35 == "Equally mixed") ~ "split"
  ))
```

```{r}
#civilian arrested - traffic stop
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_arrested_t = case_when(
    (X37 == 'Yes') ~ 1,
    (X37 == 'No') ~ 0
  ))
```

```{r}
#civilian searched - vehicle searched or civilian searched
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_searched_t = case_when(
    (X39 == "Yes" | X49 == "Yes") ~ 1,
    ((X39 == "No" | X39 == "Unkown") & (X49 == "No" | X49 == "Unknown") & !(X39 == "Unknown" & X49 == "Unknown")) ~ 0
  ))
```

```{r}
#civilian guilty of carrying illegal drugs, alcohol or wewapons
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_guilty_of_illegal_t = case_when(
    (X42 == 'Illegal weapons' | 
     X43 == 'Illegal drugs'   |
     X44 == 'Open alcohol' |
     X45 == 'Other crime evidence'|
     X52 == 'Illegal weapons'|
     X53 == 'Illegal drugs' |
     X54 == 'Open alcohol' |
     X55 == 'Other crime evidence') ~ 1,
    (X47 == 'None of the above' & X57 == 'None of the above') ~ 0
  ))
```

```{r}
#police used force
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(police_used_force_t = case_when(
    (X83 == 'Yes' | X84 == 'Yes') ~ 1,
    (X83 == 'No' | X84 == 'No') ~ 0
  )) 
```

```{r}
# Officer use of force
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(hit_kick_t = case_when(
    (X87 == 'Kicked or hit') ~ 1
  )) %>%
  mutate(grab_push_t = case_when (
    (X85 == 'Pushed or grabbed without pain' | X86 == 'Pushed or grabbed with pain') ~ 1 
  )) %>%
  mutate(point_gun_t = case_when(
    (X90 == 'Pointed gun' | X91 == 'Fired gun') ~ 1
  )) %>%
  mutate(pepper_stun_t = case_when(
    (X89 == 'Sprayed with chemical/pepper spray' ) ~ 1
  )) %>%
  mutate(other_force_t = case_when(
    (X88 == 'Unleashed police dog bit' | X92 == 'Other force') ~ 1
  ))
```

```{r}
#any force - traffic stop
ppcs_1999_tmp <- ppcs_1999_F %>%
  select(other_force_t, grab_push_t, hit_kick_t, point_gun_t, pepper_stun_t)

ppcs_1999_F <- ppcs_1999_F %>%
  mutate(force_sum_t = rowSums(ppcs_1999_tmp, na.rm = TRUE)) %>%
  mutate(any_force_t = ifelse((force_sum_t > 0) & (had_contact == 1), 1, 0))

ppcs_1999_F <- ppcs_1999_F %>%
  mutate_at(.funs = list( ~ ifelse(is.na(.) & ppcs_1999_F$any_force_t == 1, 0, .)), .vars = colnames(ppcs_1999_tmp)) %>%
  mutate_at(.funs = list( ~ ifelse(is.na(.) & ppcs_1999_F$police_used_force_t, 0, .)), .vars = colnames(ppcs_1999_tmp))
```

```{r}
# civilian is handcuffed
# officer handcuffed
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_is_handcuffed_t = case_when(
    (X82 == 'Yes') ~ 1,
    (X82 == 'No') ~ 0,
    (X82 == 'Out of Universe/Missing' & police_used_force_t == 0) ~ 0
  )) %>%
  mutate(officer_handcuffed_t = case_when(
    (civilian_is_handcuffed_t == 1 & civilian_arrested_t != 1 ) ~ 1,
    ((civilian_is_handcuffed_t == 1 & civilian_arrested_t == 1 ) | civilian_is_handcuffed_t == 0) ~ 0,
    (police_used_force_t == 0 & civilian_is_handcuffed_t == NA) ~ 0
  ))
```

```{r}
# officer fired gun, officer shot suspect

ppcs_1999_F <- ppcs_1999_F %>%
  mutate(off_fired_gun_t = case_when(
    (X91 == 'Fired gun') ~ 1
  )) %>%
  mutate(off_shot_suspect_t = case_when(
    (X118 == 'Yes' & X119 == 'Gunshot wound') ~ 1
  ))
```

```{r}
# civilian perceived excessive force
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(excessive_force_t = case_when(
    (X101 == 'Yes') ~ 1,
    (X101 == 'No') ~ 0,
    (police_used_force_t == 0 & X101 == NA) ~ 0
  ))
```

```{r}
# civilian behavior

#threatened
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_threatened_t = ifelse(X129 == 'Curse or insult officer' | X130 == 'Verbal threat to officer' | X135 == 'Threaten officer with weapon', 1, NA))

#physical
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_physical_t = ifelse(X134 == 'Grab, hit, or fight with officer' | X136 == 'Assault officer with weapon', 1, NA))

#argued
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_argued_t = ifelse(X128 == 'Argue or disobey officer', 1, NA))

#disobey - counted twice because the question is argue or disobey officer?
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_disobey_t = ifelse(X128== 'Argue or disobey officer', 1, NA))

#other behavior
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_other_behavior_t = ifelse(X137 == 'Other actions to provoke', 1, NA))

#escape
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_escape_t = ifelse(X133 == 'Try to escape', 1, NA))

#resist 
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_resist_t = ifelse(X131 == 'Resist arrest or handcuffs' | X132 == 'Resist search', 1, NA))

#complained
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_complained_t = NA)

#comment from original code; note that weapon is also a choice here but is never tagged as one so I am not concerned;
```

```{r}
#any behavior
ppcs_1999_tmp <- ppcs_1999_F %>%
  select(civilian_threatened_t, civilian_physical_t, civilian_argued_t, civilian_disobey_t, civilian_other_behavior_t, civilian_escape_t, civilian_resist_t)

ppcs_1999_F <- ppcs_1999_F %>%
  mutate(behav_sum_t = rowSums(ppcs_1999_tmp, na.rm = TRUE)) %>%
  mutate(any_behavior_t = ifelse((behav_sum_t > 0) & (had_contact == 1), 1, 0))
```

```{r}
#time of encounter
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(time_of_encounter_t = NA)
```

```{r}
# civilian injured
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_injured_t = case_when(
    (X118 == 'Yes') ~ 1,
    (X118 == 'No') ~ 0,
    (X118 == NA & police_used_force_t == 0) ~ 0
  ))
```

## Other stops

```{r}
# number of officers
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(num_officers_o = ifelse(X171 == "Out of Universe/Missing", NA_real_, X171)) %>%
  mutate(num_officers_o = ifelse(num_officers_o == "One", 1, X171)) %>%
  mutate(num_officers_o = as.numeric(num_officers_o))
```

```{r}
# Officer Race - other stop
w <- c("All white", "Mostly white")
b <- c("All black", "Mostly black")
o <- c("All of another race", "Mostly another race")
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(off_race_o = case_when(
    (( num_officers_o == 1 & X173 == 'White' ) | (num_officers_o %in% seq(2, 30) & X172 %in% w)) ~ "white" ,
    (( num_officers_o == 1 & X173 == 'Black' ) | (num_officers_o %in% seq(2, 30) & X172 %in% b)) ~ "black",
    (( num_officers_o == 1 & X173 == 'Some other race' ) | (num_officers_o %in% seq(2, 30) & X172 %in% o)) ~ "other",
    (num_officers_o %in% seq(2, 30) & X172 == "Equally mixed") ~ "split"
  ))
```

```{r}
#civilian arrested - other stop
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_arrested_o = case_when(
    (X174 == 'Yes') ~ 1,
    (X174 == 'No') ~ 0
  ))
```

```{r}
#civilian searched - vehicle searched or civilian searched
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_searched_o = case_when(
    (X176 == "Yes") ~ 1,
    (X176 == "No") ~ 0
  ))
```

```{r}
#civilian guilty of carrying illegal drugs, alcohol or wewapons
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_guilty_of_illegal_o = case_when(
    (X179 == 'Illegal weapons' | 
     X180 == 'Illegal drugs'   |
     X181 == 'Open alcohol' |
     X182 == 'Other crime evidence') ~ 1,
    
    (X184 == 'None of the above') ~ 0
  ))
```

```{r}
#police used force
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(police_used_force_o = case_when(
    (X152 == 'Yes') ~ 1,
    (X152 == 'No') ~ 0
  )) 
```

```{r}
# Officer use of force
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(hit_kick_o = case_when(
    (X200 == 'Kicked or hit') ~ 1
  )) %>%
  mutate(grab_push_o = case_when (
    (X198 == 'Pushed or grabbed without pain' | X199 == 'Pushed or grabbed with pain') ~ 1 
  )) %>%
  mutate(point_gun_o = case_when(
    (X203 == 'Pointed gun' | X204 == 'Fired gun') ~ 1
  )) %>%
  mutate(pepper_stun_o = case_when(
    (X202 == 'Sprayed with chemical/pepper spray' ) ~ 1
  )) %>%
  mutate(other_force_o = case_when(
    (X201 == 'Unleashed police dog bit' | X205 == 'Used other force') ~ 1
  ))
```

```{r}
ppcs_1999_tmp <- ppcs_1999_F %>%
  select(other_force_o, grab_push_o, hit_kick_o, point_gun_o, pepper_stun_o)

ppcs_1999_F <- ppcs_1999_F %>%
  mutate(force_sum_o = rowSums(ppcs_1999_tmp, na.rm = TRUE)) %>%
  mutate(any_force_o = ifelse((force_sum_o > 0) & (had_contact == 1), 1, 0))

ppcs_1999_F <- ppcs_1999_F %>%
  mutate_at(.funs = list( ~ ifelse(is.na(.) & ppcs_1999_F$any_force_o == 1, 0, .)), .vars = colnames(ppcs_1999_tmp)) %>%
  mutate_at(.funs = list( ~ ifelse(is.na(.) & (X196 == 'No' | X197 == 'No' | X152 == 'No'), 0, .)), .vars = colnames(ppcs_1999_tmp))
```

```{r}
# civilian is handcuffed
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_is_handcuffed_o = case_when(
    (X195 == 'Yes') ~ 1,
    (X195 == 'No') ~ 0,
    (X195 == 'Out of Universe/Missing' & police_used_force_o == 0) ~ 0
  )) %>%
  mutate(officer_handcuffed_o = case_when(
    (civilian_is_handcuffed_o == 1 & civilian_arrested_o != 1 ) ~ 1,
    ((civilian_is_handcuffed_o == 1 & civilian_arrested_o == 1 ) | civilian_is_handcuffed_o == 0) ~ 0,
    (X152 == 'No') ~ 0
  ))
```

```{r}
# officer fired gun, officer shot suspect

ppcs_1999_F <- ppcs_1999_F %>%
  mutate(off_fired_gun_o = case_when(
    (X204 == 'Fired gun') ~ 1
  )) %>%
  mutate(off_shot_suspect_o = case_when(
    (X231 == 'Yes' & X232 == 'Gunshot wound') ~ 1
  ))
```

```{r}
#civilian perceived excess force

ppcs_1999_F <- ppcs_1999_F %>%
  mutate(excessive_force_o = case_when(
    (X214 == 'Yes') ~ 1,
    (X214 == 'No') ~ 0,
    (police_used_force_o == 0 & X214 == NA) ~ 0
  ))
```

```{r}
#civilian behavior

#threatened
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_threatened_o = ifelse(X242 == 'Curse or insult officer' | X243 == 'Verbal threat to officer' | X248 == 'Threaten officer with weapon', 1, NA))

#physical
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_physical_o = ifelse(X247 == 'Grab, hit, or fight with officer' | X249 == 'Assault officer with weapon', 1, NA))

#argued
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_argued_o = ifelse(X241 == 'Argue or disobey officer', 1, NA))

#disobey - counted twice because the question is argue or disobey officer?
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_disobey_o = ifelse(X241 == 'Argue or disobey officer', 1, NA))

#other behavior
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_other_behavior_o = ifelse(X250 == 'Other actions to provoke', 1, NA))

#escape
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_escape_o = ifelse(X246 == 'Try to escape', 1, NA))

#resist 
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_resist_o = ifelse(X244 == 'Resist arrest or handcuffs' | X245 == 'Resist search', 1, NA))

#complained
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_complained_o = NA)

```

```{r}
# any behavior - other stops
ppcs_1999_tmp <- ppcs_1999_F %>%
  select(civilian_threatened_o, civilian_physical_o, civilian_argued_o, civilian_disobey_o, civilian_other_behavior_o, civilian_escape_o, civilian_resist_o)

ppcs_1999_F <- ppcs_1999_F %>%
  mutate(behav_sum_o = rowSums(ppcs_1999_tmp, na.rm = TRUE)) %>%
  mutate(any_behavior_o = ifelse((behav_sum_o > 0) & (had_contact == 1), 1, 0))
```

```{r}
#time of encounter - other stop
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(time_of_encounter_o = NA )
```

```{r}
# civilian injured
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(civilian_injured_o = case_when(
    (X231 == 'Yes') ~ 1,
    (X231 == 'No') ~ 0,
    (X231 == NA & police_used_force_o == 0) ~ 0
  ))
```

```{r}
# year
ppcs_1999_F <- ppcs_1999_F %>%
  mutate(year = 1999)
```

```{r}
#get the variable names without extension
traffic_cols <- ppcs_1999_F[ , grepl( "*_t$" , names(ppcs_1999_F) ) ]
cols <- colnames(traffic_cols)
vars <- gsub("*_t$", "", cols)

other_cols <- ppcs_1999_F[ , grepl( "*_o$" , names(ppcs_1999_F) ) ]
cols <- colnames(other_cols)
vars2 <- gsub("*_o$", "", cols)

#add id
ppcs_1999_F <- ppcs_1999_F %>% 
  mutate(id = row_number())

#reshape from wide to long
ppcs_1999_F <- ppcs_1999_F %>%
  reshape(direction = "long", idvar = 'id',
          v.names = vars, 
          varying=list(grep("*num_officers", colnames(ppcs_1999_F)),
                       grep("*off_race", colnames(ppcs_1999_F)),
                       grep("*civilian_arrested", colnames(ppcs_1999_F)),
                       grep("*civilian_searched", colnames(ppcs_1999_F)),
                       grep("*civilian_guilty_of_illegal", colnames(ppcs_1999_F)),
                       grep("*police_used_force", colnames(ppcs_1999_F)),
                       grep("*hit_kick", colnames(ppcs_1999_F)),
                       grep("*grab_push", colnames(ppcs_1999_F)),
                       grep("*point_gun", colnames(ppcs_1999_F)),
                       grep("*pepper_stun", colnames(ppcs_1999_F)),
                       grep("*other_force", colnames(ppcs_1999_F)),
                       grep("*force_sum", colnames(ppcs_1999_F)),
                       grep("*any_force", colnames(ppcs_1999_F)),
                       grep("*civilian_is_handcuffed", colnames(ppcs_1999_F)),
                       grep("*officer_handcuffed", colnames(ppcs_1999_F)),
                       grep("*off_fired_gun", colnames(ppcs_1999_F)),
                       grep("*off_shot_suspect", colnames(ppcs_1999_F)),
                       grep("*excessive_force", colnames(ppcs_1999_F)),
                       grep("*civilian_threatened", colnames(ppcs_1999_F)),
                       grep("*civilian_physical", colnames(ppcs_1999_F)),
                       grep("*civilian_argued", colnames(ppcs_1999_F)),
                       grep("*civilian_disobey", colnames(ppcs_1999_F)),
                       grep("*civilian_other_behavior", colnames(ppcs_1999_F)),
                       grep("*civilian_escape", colnames(ppcs_1999_F)),
                       grep("*civilian_resist", colnames(ppcs_1999_F)),
                       grep("*civilian_complained", colnames(ppcs_1999_F)),
                       grep("*behav_sum", colnames(ppcs_1999_F)),
                       grep("*any_behavior", colnames(ppcs_1999_F)),
                       grep("*time_of_encounter", colnames(ppcs_1999_F)),
                       grep("*civilian_injured", colnames(ppcs_1999_F))
          ),
          timevar='type',
          times=c('other', 'traffic'))
ppcs_1999_F <- ppcs_1999_F %>% select(-type)

#drop duplicates
ppcs_1999_F <- ppcs_1999_F %>% distinct()

```


```{r}
#select the columns we want
ppcs_1999_F <- ppcs_1999_F %>%
  select(
    had_contact,
    civilian_race,
    civilian_age,
    civilian_gender,
    civilian_employed,
    civilian_income,
    population_size,
    type_of_incident,
    time_of_encounter,
    police_used_force,
    other_force,
    grab_push,
    hit_kick,
    point_gun,
    civilian_is_handcuffed,
    officer_handcuffed,
    pepper_stun,
    off_fired_gun,
    off_shot_suspect,
    off_race,
    civilian_threatened,
    civilian_physical, 
    civilian_argued,
    civilian_disobey,
    civilian_resist,
    civilian_other_behavior,
    civilian_complained,
    civilian_escape,
    civilian_injured,
    excessive_force,
    civilian_searched,
    civilian_arrested,
    civilian_guilty_of_illegal,
    year
  )

save(ppcs_1999_F, file = "clean_data/ppcs_1999_F.Rdata")
```


